<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>SafeRoute</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
body { margin:0; font-family:Arial, sans-serif; }
header {
 background:#0b5ed7; color:white; padding:10px 15px;
 font-size:18px; font-weight:bold;
}
.container { display:flex; }
.sidebar {
 width:320px; background:white; padding:12px;
 height:calc(100vh - 44px);
 box-shadow:2px 0 5px rgba(0,0,0,0.15);
}
input { width:100%; padding:8px; margin:6px 0; }
button {
 width:100%; padding:10px; margin-top:6px;
 background:#0b5ed7; color:white; border:none;
 cursor:pointer;
}
button.sos { background:red; }
button.end { background:#198754; }
#map { flex:1; height:calc(100vh - 44px); }
.suggestions {
 background:white; border:1px solid #ccc;
 max-height:150px; overflow:auto;
}
.suggestions div {
 padding:6px; cursor:pointer;
}
.suggestions div:hover { background:#eee; }
.info { margin-top:8px; font-size:14px; }
.feedback { display:none; margin-top:8px; }
.feedback button {
 width:auto; margin:4px;
}
</style>
</head>

<body>

<header>SafeRoute</header>

<div class="container">

<div class="sidebar">
<input id="source" oninput="autoComplete(this,'srcSug')" placeholder="Source">
<div id="srcSug" class="suggestions"></div>

<input id="dest" oninput="autoComplete(this,'dstSug')" placeholder="Destination">
<div id="dstSug" class="suggestions"></div>

<button onclick="findRoute()">Directions</button>
<button onclick="enableTracking()">My Location</button>
<button class="end" onclick="endRide()">End Ride</button>
<button class="sos" onclick="sendSOS()">SOS</button>

<div id="info" class="info"></div>

<div id="feedback" class="feedback">
 <b>How was your ride?</b><br>
 <button onclick="submitFeedback(5)">‚≠ê Excellent</button>
 <button onclick="submitFeedback(4)">üòä Good</button>
 <button onclick="submitFeedback(3)">üòê Okay</button>
 <button onclick="submitFeedback(2)">üòü Unsafe</button>
</div>
</div>

<div id="map"></div>
</div>

<script>
var map = L.map('map').setView([20.5937,78.9629],5);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

var srcCoord=null, dstCoord=null;
var routeLine=null, srcMarker=null, dstMarker=null;
var userLocation=null;
var safetyScore=0;

// AUTOCOMPLETE SEARCH (ALL INDIA)
function autoComplete(input, boxId){
 let q=input.value;
 if(q.length<3){
   document.getElementById(boxId).innerHTML="";
   return;
 }
 fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${q}&countrycodes=in&limit=5`)
 .then(r=>r.json())
 .then(data=>{
  let box=document.getElementById(boxId);
  box.innerHTML="";
  data.forEach(p=>{
   let div=document.createElement("div");
   div.textContent=p.display_name;
   div.onclick=function(){
    input.value=p.display_name;
    if(boxId==="srcSug") srcCoord=[+p.lat,+p.lon];
    else dstCoord=[+p.lat,+p.lon];
    box.innerHTML="";
   };
   box.appendChild(div);
  });
 });
}

// ROUTE FINDING
function findRoute(){
 if(!srcCoord || !dstCoord) return;

 if(routeLine) map.removeLayer(routeLine);
 if(srcMarker) map.removeLayer(srcMarker);
 if(dstMarker) map.removeLayer(dstMarker);

 srcMarker=L.marker(srcCoord).addTo(map);
 dstMarker=L.marker(dstCoord).addTo(map);

 fetch(`https://router.project-osrm.org/route/v1/driving/${srcCoord[1]},${srcCoord[0]};${dstCoord[1]},${dstCoord[0]}?overview=full&geometries=geojson`)
 .then(r=>r.json())
 .then(data=>{
  let route=data.routes[0];
  let coords=route.geometry.coordinates.map(c=>[c[1],c[0]]);
  routeLine=L.polyline(coords,{color:"blue",weight:6}).addTo(map);
  map.fitBounds(routeLine.getBounds());

  let dist=(route.distance/1000).toFixed(1);
  let time=(route.duration/60).toFixed(0);
  safetyScore=Math.floor(Math.random()*20)+75;

  info.innerHTML =
   dist+" km ‚Ä¢ "+time+" min ‚Ä¢ Safety "+safetyScore+"%";

  document.getElementById("feedback").style.display="none";
 });
}

// LIVE LOCATION
function enableTracking(){
 if(navigator.geolocation){
  navigator.geolocation.watchPosition(pos=>{
   userLocation=[pos.coords.latitude,pos.coords.longitude];
   srcCoord=userLocation;
   source.value="My Location";
   if(srcMarker) map.removeLayer(srcMarker);
   srcMarker=L.circleMarker(userLocation,{radius:6,color:"green"}).addTo(map);
   map.setView(userLocation,15);
  });
 }
}

// END RIDE ‚Üí FEEDBACK
function endRide(){
 if(routeLine)
  document.getElementById("feedback").style.display="block";
}

// FEEDBACK SUBMIT
function submitFeedback(r){
 alert("Thank you for your feedback!");
 document.getElementById("feedback").style.display="none";
}

// SOS
function sendSOS(){
 if(!userLocation) return;
 alert("üö® SOS sent with live location");
}
</script>

</body>
</html>
